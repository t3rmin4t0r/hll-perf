package org.notmysock.benchmark;

import java.io.IOException;
import java.util.concurrent.TimeUnit;

import org.apache.commons.codec.binary.Base64;
import org.apache.hadoop.hive.common.io.NonSyncByteArrayInputStream;
import org.apache.hadoop.hive.common.ndv.NumDistinctValueEstimator;
import org.apache.hadoop.hive.common.ndv.hll.HyperLogLog;
import org.apache.hadoop.hive.common.ndv.hll.HyperLogLogUtils;
import org.openjdk.jmh.annotations.*;

@State(Scope.Benchmark)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MILLISECONDS)
@Fork(1)
@Warmup(iterations=5)
@Measurement(batchSize = 1, iterations=10)
public class HllBenchmark {
  
  @State(Scope.Benchmark)
  public static class BenchmarkState {
    final String itemHLL = "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\r\nCHKYZCjKMpCjKMZSCKw5hpIQYxFKUZDDIUiBlIQZCjONBRkIMZjDKQo0EMcpCDMgxSGIIpCGMUYx\r\nlKgZSiGQySkKUxijINJEkEEZiDGdAiHEMhSFOUpCiIMrjlOUhBkIYhTjIQRCGIUhSEYMhhkQM4zr\r\nGYZiFGUwyDKUIykGkxSkMYYyEEMRxkGIhRkRAYinIUYxoGQhSDKQpRjII5BjKQpBkOIZEEGQpBkK\r\nUqjuSMRVlGQZRpKIgxFIchSDKYhREMQhikIQozGKQhDEIQQzEQQRRjMMxBiKQYxkQIhzFGQpiEIM\r\nZzDGIZxlMIghFKcoynIUZCjKQpDmMUYzFGQZRjIQgxjKgpCpIMiRkEQYyjMMYzkEQQSlKcZCkKIo\r\nxkGYhSDKYgkEGYxCDMYSSGGdByGKQRxpQUYzFKUKCjKMpijGQZDhWMpDkMcoxlKU4yGIQpBlKMxk\r\nFINJDDMYZCmMM5DmIQxClGNQjEIUphkOExDDIUgjkKQwkCKQwyCGcZDCKYhylMURDFIYZCiIkxSn\r\nQMRCDEMYzkGQgikIIYijCYoyEKQh1nGMgkHGYgxkOUZSFKURSqGMhBDGUhRCEYohjKMayiEQhiGK\r\nQoykIQhCjQMpCCGYpSjEQqClKMhTGGYhBjKUhBjKYYxEOUhSDEQYyjIUgiFIUxTCKghjCGMRSFEg\r\nphjGchCkQUIyjMUhBkKYZDpGMgyjGQYyHGIhDCScxDiKIZDsIYYyjGMxjFIcZlFKQgzDIdAimGMh\r\nSCIIgyEOYRCFGYqCEEQoiDKMhBFEMgiGGQYilGIojjKQZDHIVBCmKUpTjEQhBlIxB0DKY5SDQUxS\r\nIKQozEQUZSnMQxjhMUpCjGUZWkEMRhlKYxBlMUxSoIQZREOMozGIMZCmWIohFIcxikKQpiLGRBRk\r\nGMxDDEQZxFQQgzlKNIiEOUgkDOQiTGKQZhjIQhBkKQYyDMgpBDIYwhhGIohmEYZCkGMphjKUZTiG\r\nghDkEUglCIYoxjIQxFCINAyFIYZCIGMIxkGQYiFIUYjFGMiEGIIoxmUNxSkMQhDDMRSRlMchzFKM\r\nhDmIRYykIQpRoIMRCEKI5zCKRBBkGUgymGMoilEUZymMMwikIMQ0DKMgykKMhBjKMwyDGNijFKhA\r\nxpGMwiHGQgyjEMhykIQZBjSQpDoGUhCnKMZBkIYgxkGIpRkKYhEjKUpCDOYoxmOYhDEQUZSHMQYy\r\n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";
    final byte[] itemBytes = Base64.decodeBase64(itemHLL);
    final String warehouseHLL = "SExM4BQUwZn6L4TaxBj+kPIhvpi3C4HHqx//ytcVgOL3TMCSiwGA9fICwbnPS8Cq/A3ByOQ4vrzO\r\nqwHBqM4JgfKLG76bsWrEua0PvLDckgGA3O8FweGzeg==";
    final byte[] warehouseBytes = Base64.decodeBase64(warehouseHLL);
    final HyperLogLog hll = HyperLogLog.builder().build();
    final NumDistinctValueEstimator nv0 = hll.deserialize(itemBytes);
    final NumDistinctValueEstimator nv1 = hll.deserialize(itemBytes);
    final NumDistinctValueEstimator nv2 = hll.deserialize(warehouseBytes);
  }


  @Benchmark
  public NumDistinctValueEstimator benchBuild(BenchmarkState state) {
    return HyperLogLog.builder().build();
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchDeserialize(BenchmarkState state) {
    return state.hll.deserialize(state.itemBytes);
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchDeserializeNonSync(BenchmarkState state) throws IOException {
    return HyperLogLogUtils.deserializeHLL(new NonSyncByteArrayInputStream(state.itemBytes));
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeDenseToDense(BenchmarkState state) throws IOException {
    // this is what really happens for item_sk columns
    state.nv0.mergeEstimators(state.nv1);
    return state.nv0;
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeSparseToDense(BenchmarkState state) throws IOException {
    state.nv0.mergeEstimators(state.nv2);
    return state.nv0;
  }
  @Benchmark
  public NumDistinctValueEstimator benchMergeDenseToSparse(BenchmarkState state) throws IOException {
    state.nv2.mergeEstimators(state.nv1);
    return state.nv2;
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeDenseToEmpty(BenchmarkState state) throws IOException {
    HyperLogLog hll = HyperLogLog.builder().build();
    hll.mergeEstimators(state.nv1);
    return hll;
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeEmptyToDense(BenchmarkState state) throws IOException {
    HyperLogLog hll = HyperLogLog.builder().build();
    state.nv1.mergeEstimators(hll);
    return state.nv1;
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeSparseToEmpty(BenchmarkState state) throws IOException {
    HyperLogLog hll = HyperLogLog.builder().build();
    hll.mergeEstimators(state.nv2);
    return hll;
  }
  
  @Benchmark
  public NumDistinctValueEstimator benchMergeEmptyToSparse(BenchmarkState state) throws IOException {
    HyperLogLog hll = HyperLogLog.builder().build();
    state.nv2.mergeEstimators(hll);
    return state.nv2;
  }
}
